# План настройки Webhook'ов Kaiten для Yandex Cloud Function

## Обзор

Цель: Настроить автоматический вызов Yandex Cloud Function при изменении карточки в Kaiten через webhook событие `card:update`.

## Текущее состояние

✅ Код функции уже поддерживает обработку HTTP-триггеров (webhook'ов)
✅ Функция умеет извлекать `card_id` из различных форматов запросов
✅ Функция корректно обрабатывает события и обновляет параметры карточек

## План действий

### Шаг 1: Получение URL HTTP-триггера Yandex Cloud Function

1. **Откройте консоль Yandex Cloud:**
   - Перейдите на https://console.cloud.yandex.ru/
   - Войдите в свой аккаунт

2. **Найдите вашу функцию:**
   - Откройте раздел **Cloud Functions**
   - Найдите функцию `kaiten-automation` (или другое имя, если вы использовали другое)

3. **Проверьте наличие HTTP-триггера:**
   - Перейдите в раздел **Триггеры** функции
   - Проверьте, есть ли уже HTTP-триггер

4. **Создайте HTTP-триггер (если его нет):**
   - Нажмите **Создать триггер**
   - Выберите тип **HTTP-триггер**
   - Настройте параметры:
     - **Имя:** `kaiten-webhook` (или любое другое)
     - **HTTP-метод:** `POST`
     - **Путь:** `/webhook` (или `/` - по умолчанию)
   - Сохраните триггер

5. **Скопируйте URL триггера:**
   - После создания триггера будет показан URL вида:
     ```
     https://functions.yandexcloud.net/<function-id>/webhook
     ```
   - **Сохраните этот URL** - он понадобится для настройки webhook в Kaiten

### Шаг 2: Настройка Webhook в Kaiten

1. **Откройте настройки пространства в Kaiten:**
   - Войдите в ваше пространство Kaiten
   - Перейдите в **Настройки** (Settings) → **Интеграции** (Integrations) или **Webhooks**

2. **Создайте новый Webhook:**
   - Найдите раздел **External Webhooks** или **Внешние Webhook'и**
   - Нажмите **Добавить webhook** или **Создать webhook**

3. **Настройте параметры webhook:**
   
   **URL:**
   - Вставьте URL вашего HTTP-триггера из Шага 1
   - Пример: `https://functions.yandexcloud.net/your-function-id/webhook`
   
   **События (Events):**
   - Выберите событие **`card:update`** или **`card.updated`**
   - Это событие срабатывает при изменении карточки
   - Если доступны другие события, можно выбрать:
     - `card:update` - обновление карточки
     - `card:custom_property:update` - обновление пользовательского свойства
   
   **HTTP-метод:**
   - Выберите **POST**
   
   **Формат данных:**
   - Обычно Kaiten отправляет JSON
   - Убедитесь, что выбран формат **JSON**

4. **Сохраните webhook:**
   - Нажмите **Сохранить** или **Создать**
   - Webhook будет активен сразу после создания

### Шаг 3: Проверка формата данных от Kaiten

Kaiten может отправлять webhook в разных форматах. Ваш код уже поддерживает несколько вариантов:

**Вариант 1: Простой формат с card_id**
```json
{
  "card_id": 12345
}
```

**Вариант 2: Формат с объектом card**
```json
{
  "card": {
    "id": 12345,
    "title": "Название карточки",
    ...
  }
}
```

**Вариант 3: Формат с событием**
```json
{
  "event": "card:update",
  "card_id": 12345,
  "card": {
    "id": 12345,
    ...
  }
}
```

**Вариант 4: Минимальный формат**
```json
{
  "id": 12345
}
```

### Шаг 4: Тестирование Webhook

#### 4.1 Тест через изменение карточки в Kaiten

1. **Откройте любую карточку в Kaiten**
2. **Измените любое поле** (например, одно из полей критериев оценки)
3. **Сохраните изменения**
4. **Проверьте логи функции:**
   - Откройте консоль Yandex Cloud
   - Перейдите в раздел **Логи** вашей функции
   - Должно появиться сообщение о получении webhook и обработке карточки

#### 4.2 Тест через curl (ручной вызов)

Вы можете протестировать функцию вручную, отправив тестовый запрос:

```bash
curl -X POST https://functions.yandexcloud.net/your-function-id/webhook \
  -H "Content-Type: application/json" \
  -d '{"card_id": 12345}'
```

Замените:
- `your-function-id` на ID вашей функции
- `12345` на реальный ID карточки из Kaiten

#### 4.3 Проверка результата

1. **Откройте карточку в Kaiten**
2. **Проверьте, что поля результатов обновились:**
   - Рейтинг Качества
   - Тип Контента
   - Уровень спикера
   - Охват

### Шаг 5: Настройка фильтрации событий (опционально)

Если вы хотите обрабатывать только определенные изменения:

1. **В коде функции** (уже реализовано):
   - Функция автоматически извлекает `card_id` из webhook
   - Обрабатывает только карточки с валидным `card_id`

2. **В настройках webhook Kaiten:**
   - Некоторые версии Kaiten позволяют фильтровать события
   - Можно настроить обработку только определенных типов изменений

### Шаг 6: Мониторинг и отладка

#### 6.1 Просмотр логов

**В консоли Yandex Cloud:**
1. Откройте функцию
2. Перейдите в раздел **Логи**
3. Фильтруйте по времени или тексту

**Что искать в логах:**
- `"Получено событие"` - webhook получен
- `"Обработка карточки {card_id} из вебхука"` - начата обработка
- `"Параметры карточки {card_id} успешно обновлены"` - успешное завершение
- Ошибки с описанием проблемы

#### 6.2 Типичные проблемы и решения

**Проблема: Webhook не срабатывает**

**Проверьте:**
1. ✅ URL webhook в Kaiten правильный и доступен
2. ✅ HTTP-триггер создан и активен в Yandex Cloud
3. ✅ Событие `card:update` выбрано в настройках webhook
4. ✅ Проверьте логи функции - возможно, запросы приходят, но есть ошибки

**Решение:**
- Проверьте доступность URL через curl или Postman
- Убедитесь, что функция возвращает статус 200 (не 500)
- Проверьте логи на наличие ошибок

---

**Проблема: Webhook срабатывает, но карточка не обновляется**

**Проверьте:**
1. ✅ Правильность ID полей в переменных окружения
2. ✅ API токен имеет права на обновление карточек
3. ✅ Значения критериев заполнены в карточке
4. ✅ Логи показывают успешное обновление

**Решение:**
- Проверьте переменные окружения функции
- Убедитесь, что API токен валиден
- Проверьте логи на наличие предупреждений о полях

---

**Проблема: Ошибка "card_id not found in request"**

**Причина:**
- Kaiten отправляет webhook в формате, который не распознается кодом

**Решение:**
1. Проверьте логи функции - там должен быть полный body запроса
2. Если формат отличается, можно:
   - Обновить код функции для поддержки нового формата
   - Или настроить webhook в Kaiten на другой формат (если доступно)

**Для отладки добавьте в логи:**
- Код уже логирует полный event: `logger.info(f"Получено событие: {json.dumps(event, ...)})`
- Проверьте логи, чтобы увидеть точный формат от Kaiten

---

**Проблема: Таймаут функции**

**Причина:**
- Обработка карточки занимает слишком много времени

**Решение:**
1. Увеличьте таймаут функции в настройках (максимум 300 секунд)
2. Проверьте, нет ли проблем с API Kaiten (медленные ответы)
3. Убедитесь, что функция не обрабатывает слишком много карточек одновременно

### Шаг 7: Безопасность (рекомендуется)

1. **Проверка подписи webhook (если поддерживается Kaiten):**
   - Некоторые системы позволяют подписывать webhook'и
   - Если Kaiten поддерживает, настройте проверку подписи в коде

2. **Ограничение доступа к HTTP-триггеру:**
   - В Yandex Cloud Functions можно настроить авторизацию для HTTP-триггера
   - Добавьте проверку токена или IP-адресов (если возможно)

3. **Мониторинг:**
   - Настройте алерты на ошибки функции
   - Отслеживайте количество вызовов

## Структура данных webhook от Kaiten

На основе документации Kaiten, webhook событие `card:update` обычно содержит:

```json
{
  "event": "card:update",
  "card": {
    "id": 12345,
    "title": "Название карточки",
    "board_id": 67890,
    "space_id": 11111,
    "custom_properties": [
      {
        "id": 1,
        "property_id": 100,
        "name": "Актуальность",
        "value": 4,
        "type": "number"
      },
      ...
    ],
    ...
  },
  "changes": {
    "custom_properties": [
      {
        "property_id": 100,
        "old_value": 3,
        "new_value": 4
      }
    ]
  },
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**Важно:** Точный формат может отличаться в зависимости от версии Kaiten. Ваш код уже поддерживает извлечение `card_id` из различных форматов.

## Дополнительные настройки

### Настройка обработки только определенных полей

Если вы хотите обрабатывать только изменения определенных полей (например, только критериев оценки):

1. В коде функции можно добавить проверку измененных полей
2. Обрабатывать карточку только если изменились нужные поля

**Пример логики (можно добавить в код):**
```python
# В handle_http_trigger после получения body
changes = body.get('changes', {})
changed_properties = changes.get('custom_properties', [])

# Список ID полей критериев, которые нас интересуют
criteria_field_ids = [
    config.get('field_aktualnost'),
    config.get('field_novizna'),
    # ... другие поля
]

# Проверяем, изменились ли интересующие нас поля
relevant_changes = [
    ch for ch in changed_properties
    if ch.get('property_id') in criteria_field_ids
]

if not relevant_changes:
    logger.info("Изменения не затрагивают критерии оценки, пропускаем")
    return {'statusCode': 200, 'body': json.dumps({'status': 'ignored'})}
```

### Настройка retry при ошибках

Yandex Cloud Functions автоматически повторяет вызовы при ошибках (для некоторых типов триггеров). Для HTTP-триггеров обычно retry не используется, но можно настроить в Kaiten.

## Чек-лист настройки

- [ ] HTTP-триггер создан в Yandex Cloud Functions
- [ ] URL триггера скопирован
- [ ] Webhook создан в Kaiten с правильным URL
- [ ] Событие `card:update` выбрано в webhook
- [ ] Webhook протестирован через изменение карточки
- [ ] Логи проверены на наличие ошибок
- [ ] Карточка корректно обновляется после изменения
- [ ] Мониторинг настроен (опционально)

## Полезные ссылки

- [Документация Kaiten Webhooks](https://developers.kaiten.ru/external-webhooks)
- [Документация Kaiten card:update](https://developers.kaiten.ru/external-webhooks/card/card:update)
- [Документация Yandex Cloud Functions](https://cloud.yandex.ru/docs/functions/)
- [Руководство по интеграции](./INTEGRATION_GUIDE.md)

## Поддержка

Если возникли проблемы:
1. Проверьте логи функции в консоли Yandex Cloud
2. Проверьте настройки webhook в Kaiten
3. Убедитесь, что все переменные окружения установлены правильно
4. Проверьте доступность URL функции извне
