# Руководство по интеграции Kaiten и Yandex Cloud Functions

Это руководство описывает процесс настройки автоматизации вычисления параметров для комиссии на основе критериев оценки докладов в Kaiten.

## Обзор системы

Система автоматически вычисляет 4 параметра для комиссии на основе критериев оценки:

1. **Рейтинг Качества** (Золото/Серебро/Бронза) - на основе: Актуальность + Новизна + Опыт спикера
2. **Тип Контента** (Хардкор/Массовость/Практический кейс/Вдохновение/Обзор) - на основе: Применимость
3. **Уровень спикера** (Хедлайнер/Хороший Спикер/Эксперт) - на основе: Харизма + IT-инфлюенсер
4. **Охват** (Ниша/Кросс/Для всех) - на основе: Массовость

## Шаг 1: Подготовка полей в Kaiten

### 1.1 Создание полей критериев (входные данные)

В настройках пространства Kaiten создайте следующие пользовательские поля:

#### Числовые поля (оценки от 1 до 5):
- **Актуальность** (Number) - ID поля сохраните +
- **Новизна** (Number) - ID поля сохраните +
- **Опыт спикера** (Number) - ID поля сохраните +
- **Харизма** (Number) - ID поля сохраните +

#### Числовые поля (оценки от 1 до 5):
- **Применимость** (Number) - ID поля сохраните
  - 1 - Вдохновиться
  - 2 - Без рецепта
  - 3 - Фрагментарно
  - 4 - Toolkit
  - 5 - Под ключ
- **Массовость** (Number) - ID поля сохраните
  - 1 - Для профи
  - 2 - Для своих
  - 3 - Связующее звено
  - 4 - Для всей команды
  - 5 - Для всей IT-кухни

#### Текстовые/Select поля:
- **IT-инфлюенсер** (Select или Boolean) - варианты: "Да"/"Нет" или True/False

### 1.2 Создание полей результатов (выходные данные)

Создайте следующие поля, которые будут автоматически заполняться:

- **Рейтинг Качества** (Select) - варианты: "Золото", "Серебро", "Бронза"
- **Тип Контента** (Select) - варианты: "Хардкор", "Массовость", "Практический кейс", "Вдохновение/Обзор"
- **Уровень спикера** (Select) - варианты: "Хедлайнер", "Хороший Спикер", "Эксперт"
- **Охват** (Select) - варианты: "Ниша", "Кросс", "Для всех"

**Важно:** Сохраните ID всех полей - они понадобятся для настройки функции.

## Шаг 2: Получение API токена Kaiten

1. Откройте настройки вашего пространства в Kaiten
2. Перейдите в раздел **API** или **Интеграции**
3. Создайте новый API токен
4. Сохраните токен в безопасном месте

## Шаг 3: Развертывание функции в Yandex Cloud Functions

### 3.1 Подготовка кода

1. Упакуйте код:
```bash
./pack_for_yandex_cloud.sh
```

2. Убедитесь, что создан файл `kaiten-automation.zip`

### 3.2 Создание функции

1. Откройте [Yandex Cloud Console](https://console.cloud.yandex.ru/)
2. Перейдите в раздел **Cloud Functions**
3. Нажмите **Создать функцию**
4. Заполните:
   - **Имя:** `kaiten-conference-evaluator`
   - **Описание:** `Автоматизация вычисления параметров для комиссии Kaiten`
   - **Среда выполнения:** `python311`

### 3.3 Загрузка кода

1. В разделе **Код функции** выберите **ZIP-архив**
2. Загрузите `kaiten-automation.zip`
3. Укажите:
   - **Точка входа:** `index.handler`
   - **Таймаут:** 60 секунд
   - **Память:** 128 МБ

### 3.4 Настройка переменных окружения

В разделе **Переменные окружения** добавьте:

```env
# Kaiten API
KAITEN_API_URL=https://your-space.kaiten.ru/api/latest
KAITEN_API_TOKEN=your_api_token_here

# ID полей критериев (входные данные)
FIELD_AKTUALNOST=field_id_aktualnost
FIELD_NOVIZNA=field_id_novizna
FIELD_OPYT_SPIKERA=field_id_opyt_spikera
FIELD_PRIMENIMOST=field_id_priminimost
FIELD_HARIZMA=field_id_harizma
FIELD_INFLUENCER=field_id_influencer
FIELD_MASSOVOST=field_id_massovost

# ID полей результатов (выходные данные)
FIELD_RATING_KACHESTVA=field_id_rating_kachestva
FIELD_TIP_KONTENTA=field_id_tip_kontenta
FIELD_UROVEN_SPIKERA=field_id_uroven_spikera
FIELD_OHVAT=field_id_ohvat
```

**Важно:** Замените все `field_id_*` на реальные ID полей из Kaiten.

## Шаг 4: Настройка вебхуков в Kaiten

### 4.1 Создание HTTP-триггера в Yandex Cloud Functions

1. В функции перейдите в раздел **Триггеры**
2. Нажмите **Создать триггер**
3. Выберите **HTTP-триггер**
4. Настройте:
   - **Имя:** `kaiten-webhook`
   - **HTTP-метод:** `POST`
   - **Путь:** `/webhook`
5. Скопируйте **URL триггера** - он понадобится для настройки вебхука в Kaiten

### 4.2 Настройка вебхука в Kaiten

1. Откройте настройки пространства в Kaiten
2. Найдите раздел **Webhooks** или **Интеграции**
3. Добавьте новый вебхук:
   - **URL:** `https://functions.yandexcloud.net/your-function-id/webhook`
   - **События:** Выберите "Card Updated" или "Custom Property Changed"
   - **Метод:** POST
   - **Формат:** JSON

**Примечание:** Если Kaiten не поддерживает вебхуки напрямую, используйте Timer-триггер (см. ниже).

## Шаг 5: Альтернатива - Timer-триггер (периодический запуск)

Если вебхуки недоступны, настройте периодический запуск:

1. В функции перейдите в раздел **Триггеры**
2. Нажмите **Создать триггер**
3. Выберите **Timer**
4. Настройте:
   - **Имя:** `kaiten-schedule`
   - **Cron-выражение:** `*/5 * * * *` (каждые 5 минут)

Функция будет автоматически обрабатывать все карточки по расписанию.

## Шаг 6: Тестирование

### 6.1 Тест через консоль Yandex Cloud

1. Откройте функцию в консоли
2. Перейдите в раздел **Тестирование**
3. Выберите **HTTP-триггер**
4. Введите тестовые данные:
```json
{
  "httpMethod": "POST",
  "body": "{\"card_id\": 12345}"
}
```

### 6.2 Тест через curl

```bash
curl -X POST https://functions.yandexcloud.net/your-function-id/webhook \
  -H "Content-Type: application/json" \
  -d '{"card_id": 12345}'
```

### 6.3 Проверка результатов

1. Откройте карточку в Kaiten
2. Проверьте, что поля результатов заполнены:
   - Рейтинг Качества
   - Тип Контента
   - Уровень спикера
   - Охват

## Логика вычислений

### Рейтинг Качества

На основе суммы: **Актуальность + Новизна + Опыт спикера**

- **Золото:** Сумма >= 13 ИЛИ все >= 4
- **Серебро:** Сумма >= 9 ИЛИ все >= 3
- **Бронза:** Остальные случаи

### Тип Контента

На основе: **Применимость** (числовое поле 1-5)

- **Хардкор:** Применимость = 5 (Под ключ) И Массовость <= 2 (Для профи/Для своих)
- **Массовость:** Применимость = 5 (Под ключ) И Массовость > 2
- **Практический кейс:** Применимость = 3 (Фрагментарно) или 4 (Toolkit)
- **Вдохновение/Обзор:** Применимость = 1 (Вдохновиться) или 2 (Без рецепта)

**Соответствия значений Применимости:**
- 1 - Вдохновиться (общее рассуждение, философия)
- 2 - Без рецепта (есть идеи, но нет практических выводов)
- 3 - Фрагментарно (есть инструменты, но частично)
- 4 - Toolkit (понятные инструменты/шаги/шаблоны)
- 5 - Под ключ (полноценный набор практик, "могу применять завтра")

### Уровень спикера

На основе: **Харизма** (числовое поле 1-5) + **IT-инфлюенсер** (текстовое поле)

- **Хедлайнер:** Харизма >= 5 И Инфлюенсер = "Да"
- **Хороший Спикер:** Харизма >= 4
- **Эксперт:** Харизма >= 1

### Охват

На основе: **Массовость** (числовое поле 1-5)

- **Для всех:** Массовость = 4 (Для всей команды) или 5 (Для всей IT-кухни)
- **Кросс:** Массовость = 3 (Связующее звено)
- **Ниша:** Массовость = 1 (Для профи) или 2 (Для своих)

**Соответствия значений Массовости:**
- 1 - Для профи (узкие специалисты с глубоким опытом)
- 2 - Для своих (в первую очередь для PM)
- 3 - Связующее звено (PM + одна-две смежные роли)
- 4 - Для всей команды (все ключевые участники команды разработки)
- 5 - Для всей IT-кухни (абсолютно для всех на конференции)

## Мониторинг и отладка

### Просмотр логов

1. В консоли Yandex Cloud откройте функцию
2. Перейдите в раздел **Логи**
3. Проверьте сообщения об обработке карточек

### Типичные проблемы

1. **Поля не обновляются:**
   - Проверьте правильность ID полей в переменных окружения
   - Убедитесь, что API токен имеет права на обновление карточек

2. **Ошибки вычислений:**
   - Проверьте, что все поля критериев заполнены
   - Убедитесь, что значения соответствуют ожидаемым форматам

3. **Вебхук не срабатывает:**
   - Проверьте URL вебхука в Kaiten
   - Убедитесь, что событие "Card Updated" выбрано
   - Проверьте логи функции на наличие запросов

## Безопасность

⚠️ **Важно:**
- Храните API токены в переменных окружения, не в коде
- Используйте HTTPS для вебхуков
- Ограничьте доступ к HTTP-триггеру (если возможно)
- Регулярно обновляйте API токены

## Дополнительные ресурсы

- [Документация Kaiten API](https://developers.kaiten.ru/)
- [Документация Yandex Cloud Functions](https://cloud.yandex.ru/docs/functions/)
- [Критерии оценки докладов](https://docs.google.com/document/d/1vioZte89l-NDFBSZhjhqIrJRLI7TnGjxgk5d7BSROlI/edit)
