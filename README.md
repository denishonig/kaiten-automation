# Автоматизация Kaiten - Вычисление параметров для комиссии

Автоматизация для сервиса Kaiten, которая вычисляет параметры для комиссии на основе критериев оценки докладов.

## Описание

Система автоматически вычисляет 4 параметра для комиссии на основе критериев оценки:

1. **Рейтинг Качества** (Золото/Серебро/Бронза) - на основе: Актуальность + Новизна + Опыт спикера
2. **Тип Контента** (Хардкор/Массовость/Практический кейс/Вдохновение/Обзор) - на основе: Применимость
3. **Уровень спикера** (Хедлайнер/Хороший Спикер/Эксперт) - на основе: Харизма + IT-инфлюенсер
4. **Охват** (Ниша/Кросс/Для всех) - на основе: Массовость

При изменении любого исходного критерия автоматически пересчитываются все параметры и обновляются в карточке.

## Требования

- Python 3.8+
- Доступ к Kaiten API (API токен)
- Права на чтение и обновление карточек в Kaiten

## Установка

1. Клонируйте репозиторий или скопируйте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Скопируйте файл конфигурации и заполните его:
```bash
cp config.example.env .env
```

4. Отредактируйте `.env` файл и укажите:
   - URL вашего Kaiten пространства
   - API токен
   - ID числовых полей для суммирования
   - ID поля статуса для обновления

## Конфигурация

Откройте файл `.env` и настройте следующие параметры:

```env
# URL вашего Kaiten пространства
KAITEN_API_URL=https://your-space.kaiten.ru/api/latest

# API токен (можно получить в настройках Kaiten)
KAITEN_API_TOKEN=your_api_token_here

# ID числовых полей через запятую
NUMERIC_FIELD_IDS=field_id_1,field_id_2,field_id_3

# ID поля статуса
STATUS_FIELD_ID=status_field_id

# Значения статусов (опционально)
STATUS_GOLD=Gold
STATUS_SILVER=Silver
STATUS_BRONZE=Bronze

# Пороговые значения (опционально)
THRESHOLD_GOLD=13
THRESHOLD_SILVER=9
```

### Как найти ID полей в Kaiten

1. Откройте карточку в Kaiten
2. Откройте инструменты разработчика браузера (F12)
3. Посмотрите структуру данных карточки в Network запросах к API
4. Или используйте API напрямую для получения информации о карточке

## Использование

### Вариант 1: Обработка одной карточки

```bash
python kaiten_automation.py <card_id>
```

Например:
```bash
python kaiten_automation.py 12345
```

### Вариант 2: Обработка всех карточек

```bash
python kaiten_automation.py
```

Обработает все карточки на указанной доске или в пространстве (если указаны `BOARD_ID` или `SPACE_ID` в `.env`).

### Вариант 3: Вебхук-сервер (рекомендуется)

Запустите вебхук-обработчик:

```bash
python webhook_handler.py
```

Сервер будет слушать на порту 5000 (по умолчанию) и обрабатывать события от Kaiten.

Для настройки вебхука в Kaiten:
1. Перейдите в настройки пространства
2. Найдите раздел "Webhooks" или "Интеграции"
3. Добавьте URL вашего сервера: `http://your-server:5000/webhook/kaiten`
4. Выберите событие "Card Updated" или аналогичное

## Где и как запускать автоматизацию

### Рекомендация 1: Yandex Cloud Functions (рекомендуется для облака)

**Где запускать:**
- Yandex Cloud Functions (serverless)

**Преимущества:**
- Не требует собственного сервера
- Автоматическое масштабирование
- Оплата только за использование
- Встроенная поддержка HTTP и Timer триггеров
- Простое управление через консоль

**Инструкция по развертыванию:**
См. подробную инструкцию в файле [yandex-cloud-deploy.md](yandex-cloud-deploy.md)

**Быстрый старт:**
1. Создайте ZIP-архив с `index.py`, `kaiten_automation.py` и `requirements.txt`
2. Загрузите в Yandex Cloud Functions
3. Настройте переменные окружения
4. Создайте HTTP или Timer триггер

### Рекомендация 2: Вебхук-сервер на собственном сервере

**Где запускать:**
- На вашем сервере
- В Docker контейнере

**Преимущества:**
- Мгновенная реакция на изменения
- Минимальная нагрузка на API
- Полный контроль над инфраструктурой

**Пример запуска:**
```bash
# Локально
python webhook_handler.py

# В Docker
docker build -t kaiten-automation .
docker run -d -p 5000:5000 --env-file .env kaiten-automation

# С использованием systemd (Linux)
# Создайте файл /etc/systemd/system/kaiten-automation.service
```

### Рекомендация 3: Периодический запуск (cron)

**Где запускать:**
- На сервере с cron
- В облачном планировщике задач

**Преимущества:**
- Простота настройки
- Не требует вебхуков от Kaiten
- Надежность (можно перезапустить при сбое)

**Пример настройки cron:**
```bash
# Запуск каждые 5 минут
*/5 * * * * cd /path/to/kaiten-automation && /usr/bin/python3 kaiten_automation.py >> /var/log/kaiten-automation.log 2>&1
```

### Рекомендация 4: Другие облачные функции

**Где запускать:**
- AWS Lambda
- Google Cloud Functions
- Azure Functions
- Yandex Cloud Functions

**Преимущества:**
- Не требует собственного сервера
- Автоматическое масштабирование
- Оплата только за использование

**Недостатки:**
- Может потребоваться адаптация кода под конкретную платформу
- Ограничения по времени выполнения

### Рекомендация 4: Интеграция через no-code платформы

Если не хотите поддерживать собственный код, можно использовать:
- **Zapier** - поддерживает Kaiten
- **Albato** - поддерживает Kaiten
- **Nekton** - поддерживает Kaiten

## Структура проекта

```
kaiten-automation/
├── kaiten_automation.py    # Основной скрипт автоматизации
├── index.py                # Handler для Yandex Cloud Functions
├── webhook_handler.py      # Вебхук-сервер
├── test_automation.py      # Тесты логики автоматизации
├── get_card_info.py        # Утилита для получения информации о карточке
├── requirements.txt        # Зависимости Python
├── config.example.env      # Пример конфигурации
├── .env                    # Ваша конфигурация (создайте из example)
├── Dockerfile              # Docker образ
├── docker-compose.yml      # Docker Compose конфигурация
├── pack_for_yandex_cloud.sh # Скрипт упаковки для Yandex Cloud
├── yandex-cloud-deploy.md  # Инструкция по развертыванию в Yandex Cloud
├── systemd/                # Пример systemd сервиса
└── README.md              # Документация
```

## Логирование

Все действия логируются в консоль. Для продакшена рекомендуется настроить ротацию логов:

```bash
# Пример с использованием logrotate
/var/log/kaiten-automation.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

## Обработка ошибок

Скрипт обрабатывает следующие ошибки:
- Отсутствие карточки
- Неверный формат данных полей
- Ошибки API Kaiten
- Проблемы с сетью

Все ошибки логируются с подробной информацией.

## Безопасность

⚠️ **Важно:**
- Никогда не коммитьте файл `.env` в git
- Храните API токены в безопасном месте
- Используйте HTTPS для вебхуков в продакшене
- Ограничьте доступ к вебхук-эндпоинту (например, через IP whitelist)

## Отладка

Для включения подробного логирования установите уровень DEBUG:

```python
logging.basicConfig(level=logging.DEBUG)
```

Или через переменную окружения:
```bash
export LOG_LEVEL=DEBUG
python kaiten_automation.py
```

## Тестирование

Перед использованием в продакшене рекомендуется протестировать логику:

```bash
python test_automation.py
```

Скрипт проверит:
- Правильность определения статуса на основе суммы
- Обработку различных граничных случаев
- Обновление статуса карточек

Тесты не требуют реального подключения к Kaiten API и используют мок-данные.

## Поддержка

При возникновении проблем:
1. Проверьте логи
2. Убедитесь, что API токен валиден
3. Проверьте, что ID полей указаны правильно
4. Убедитесь, что у API токена есть права на обновление карточек
5. Запустите тесты: `python test_automation.py`

## Дополнительная информация

- **Документация Kaiten API:** https://developers.kaiten.ru/
- **Руководство по интеграции:** [INTEGRATION_GUIDE.md](INTEGRATION_GUIDE.md) - подробная инструкция по настройке Kaiten и Yandex Cloud Functions
- **Критерии оценки докладов:** https://docs.google.com/document/d/1vioZte89l-NDFBSZhjhqIrJRLI7TnGjxgk5d7BSROlI/edit
